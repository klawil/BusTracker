<!DOCTYPE html>
<html>
<head>
<title>WSU Bus Tracking</title>
<style type="text/css">
	html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
</style>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
</head>
<body>
<div id="map-canvas"></div>
<script type="text/javascript">
var map;
var BusArray = new Array();
var WaypointArray = new Array();
function Bus() {
	this.BusId;
	this.Name;
	this.RouteId;
	this.Latitude;
	this.Longitude;
	this.Velocity;
	this.LastWaypointIndex;
	this.LastReceived;
	this.ArrivalTimeRemaining;
	this.Marker;
	this.icon;
	this.update = update;
	function update(){
		this.Marker.setMap(null);
		this.Marker = new google.maps.Marker({
			position: new google.maps.LatLng(this.Latitude,this.Longitude),
			map: map,
			title: this.Title,
			icon: this.icon
		});
	}
	this.setIcon = setIcon;
	function setIcon(){
		if ( this.RouteId == 1 ) {
			this.icon = "bus_1.png";
		} else {
			this.icon = "bus_2.png";
		}
	}
}
function Waypoint(Information) {
	this.WaypointId = Information["WaypointId"];
	this.Name = Information["Name"];
	this.Latitude = Information["Latitude"];
	this.Longitude = Information["Longitude"];
	if ( Information["WaypointMaps"].length == 2 && Information["WaypointMaps"][0]["RouteId"] != Information["WaypointMaps"][1]["RouteId"] ) {
		this.Icon = "bus_stop.png";
	} else {
		this.Icon = "bus_stop" + Information["WaypointMaps"][0]["RouteId"] + ".png";
	}
	this.Marker = new google.maps.Marker({
		position: new google.maps.LatLng(this.Latitude,this.Longitude),
		map: map,
		title: this.Name,
		icon: this.Icon
	});
}
function UpdateLocation() {
	if ( window.XMLHttpRequest ) {
		xmlhttp = new XMLHttpRequest();
	} else {
		xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
	}
	xmlhttp.onreadystatechange=function() {
		if ( xmlhttp.readyState == 4 && xmlhttp.status == 200 ) {
			LocationInfo = JSON.parse(xmlhttp.responseText);
			for ( var index = 0; index < LocationInfo.length; index++ ) {
				
			}
		} else if ( xmlhttp.readyState == 4 && xmlhttp.status != 200 ) {
			window.alert("Error accessing bus information");
		}
	}
	xmlhttp.open("GET","http://www.niar.wichita.edu/webservices/bus/api/bus",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send();
}
function GetStaticInfo() {
	if ( window.XMLHttpRequest ) {
		xmlhttp = new XMLHttpRequest();
	} else {
		xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
	}
	xmlhttp.onreadystatechange=function() {
		if ( xmlhttp.readyState == 4 && xmlhttp.status == 200 ) {
			BusInfo = JSON.parse(xmlhttp.responseText);
			for ( var index = 0; index < BusInfo.length; index++ ) {
				BusArray[index] = new Bus();
				BusArray[index].BusId = BusInfo[index]["BusId"];
				BusArray[index].Name = BusInfo[index]["Name"];
				BusArray[index].RouteId = BusInfo[index]["RouteId"];
				BusArray[index].setIcon();
			}
		} else if ( xmlhttp.readyState == 4 && xmlhttp.status != 200 ) {
			window.alert("Error accessing bus information");
		}
	}
	xmlhttp.open("GET","http://www.niar.wichita.edu/webservices/bus/api/bus",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send();
	if ( window.XMLHttpRequest ) {
		xmlhttp2 = new XMLHttpRequest();
	} else {
		xmlhttp2 = new ActiveXObject("Microsoft.XMLHTTP");
	}
	xmlhttp2.onreadystatechange=function() {
		if ( xmlhttp2.readyState == 4 && xmlhttp2.status == 200 ) {
			WaypointInfo = JSON.parse(xmlhttp2.responseText);
			for ( var index2 = 0; index2 < WaypointInfo.length; index2++ ) {
				WaypointArray[index2] = new Waypoint(WaypointInfo[index2]);
			}
		} else if ( xmlhttp2.readyState == 4 && xmlhttp2.status != 200 ) {
			window.alert("Error accessing bus information");
		}
	}
	xmlhttp2.open("GET","http://www.niar.wichita.edu/webservices/bus/api/waypoint",true);
	xmlhttp2.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp2.send();
}
function initialize() {
	var mapOptions = {
		center: { lat: 37.719419, lng: -97.289713},
		zoom: 16
	};
	map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);
	GetStaticInfo();
	var marker = new google.maps.Marker({
		position: new google.maps.LatLng(37.720,-97.290),
		map: map,
		title: "Test",
		icon: "bus_1.png"
	});
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>
</body>
